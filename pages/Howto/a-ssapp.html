<psk-page title="How to create a SSApp">
    <psk-toc title="Table of contents"></psk-toc>

    <psk-description title="Summary">
        <p>This guide will provide the necessary information on how to create and run a SSApp.</p>
    </psk-description>

    <psk-chapter title="Prerequisites">
        <p>In order to get started you need to install the <a href="https://github.com/PrivateSky/web-wallet" target="_blank">web-wallet</a> bundle by following the steps provided on the <psk-link page="quick start/installation">Setup page</psk-link> (Setup SSApps section).</p>

        <p><strong>web-wallet</strong> bundles all the necessary dependencies for building and running SSApps in a single package.</p>
    </psk-chapter>

    <psk-chapter title="web-wallet architecture">
        <psk-chapter title="Core components">
            <p>The <strong>web-wallet</strong> bundle contains the following core components required for building and running a Self Sovereign Application:</p>

            <ul>
                <li>Octopus task runner</li>
                <li>PrivateSky local installation</li>
                <li>Web Server</li>
                <li>Wallet template</li>
                <li>User Profile demo application</li>
                <li>SSApp application loader</li>
            </ul>

            <p><strong>Octopus</strong> is the first tool installed by the web-wallet and it is used to further fetch and build the rest of the dependencies. For more information on Octopus read the <psk-link page="Tools/Octopus">dedicated page</psk-link> in the documentation.</p>

            <p><strong>PrivateSky</strong> provides the VirtualMQ service and the javascript runtime bundles required for a SSApp to interact with EDFS and PrivateSky nodes</p>

            <p>The <strong>web server</strong> functionality is provided by VirtualMQ which is configured to serve static files from the <code>web-server</code> directory inside the <strong>web-wallet</strong> installation. Besides serving static files, the server exposes the Brick Storage API required to store data to EDFS.</p>

            <p>The <strong>wallet template</strong> installed by <strong>web-wallet</strong> is a plain customisable SSApp which once loaded will display a menu with  all the SSApp applications contained in this <code>web-wallet</code> installation. Through this app you will be able to access your newly created SSApp.</p>

            <p>The <strong>SSApp application loader</strong> is the first thing you'll see after running the <code>web-wallet</code> web server and accessing <code>http://localhost:8080/secure-channels/loader</code>. It is a basic web application which allows creation and loading of wallets based on the <em>menu wallet</em> template. The SSApp loader registers a service worker responsible with loading the built SSApps from the Brick Storage.</p>

            <p><strong>Before advancing to the next chapters make sure you have correctly installed <code>web-wallet</code> and have started the web server:</strong></p>
            <psk-code>
                cd web-wallet
                npm run server
            </psk-code>
        </psk-chapter>
    </psk-chapter>

    <psk-chapter title="SSApp Tutorial">
        <psk-highlight type-of-highlight="example">If you are using a Windows operating system you will need to adapt some bash commands shown in this tutorial in order to execute them.</psk-highlight>

        <p>The gist of creating, integrating and developing a SSApp in <code>web-wallet</code> is:</p>
        <psk-list list-type="ordered">
            Create a git repository containing the minimum required configuration files for your application
            Add the application into <code>web-wallet</code>
            Bind the application to the web-wallet's solution
            Enter the development cycle
        </psk-list>

        <p>All of the above steps are detailed in the following chapters.</p>

        <psk-chapter title="Creating the folder structure">
            <p>Start with creating a folder named after your application and initialize an empty git repository. For the purpose of this tutorial we will create a basic "To Do list" application.</p>
            <psk-code>
                mkdir todo-app
                cd todo-app
                git init
            </psk-code>

            <p>A <code>.gitignore</code> is recommened in order to ignore some dependencies that will be later installed using Octopus:</p>
            <psk-code>
                # .gitignore
                /code/cardinal
                /code/cardinal.js
                /temp
                /node_modules
                seed
            </psk-code>

            <p>A typical SSApp will have the following structure:
                <ul>
                    <li>bin/</li>
                    <li>code/</li>
                    <li>octopus.json</li>
                    <li>package.json</li>
                </ul>
            </p>
            <p>The <code>bin</code> folder contains executable scripts and for this SSApp to be compatible with <strong>web-wallet</strong> a <code>build.js</code> script is required. For now go ahead and copy the <code>build.js</code> script from <code>web-wallet/profile-app/bin</code>
            </p>
            <psk-code>
                # todo-app/
                mkdir -p bin code
                cp [path/to/web-wallet]/profile-app/bin/build.js bin/
            </psk-code>

            <p>This build script will create an empty Brick Archive, copy the application's code from the <code>code</code> folder into the BAR and write the BAR's SEED into a file in the root of the application's directory. This seed file will be later read by the SSApp loader in order to load the application.</p>

            <p>The <code>code</code> folder will contain the application source code files (html, javacript &amp; css files).</p>

            <p>Generate a new <code>package.json</code> file using <code>npm init</code> or copy and paste the following example and add it inside the application folder:</p>
            <psk-code language="javascript">
                {
                    "name": "todo-app",
                    "version": "1.0.0",
                    "description": "To do list SSApp",
                    "main": "index.js",
                    "scripts": {
                        "postinstall": "node ./node_modules/octopus/scripts/run",
                        "prebuild": "node ./node_modules/octopus/scripts/run prebuild",
                        "build": "node ./bin/build",
                        "test": "echo \"Error: no test specified\" && exit 1"
                    },
                    "dependencies": {
                        "octopus": "git+https://github.com/PrivateSky/octopus.git#1.0"
                    },
                    "keywords": [
                        "ssapp"
                    ],
                    "author": "",
                    "license": "MIT"
                }
            </psk-code>

            <p>As you can see in the file above, the only required dependency is the <strong>Octopus</strong> package, this will help with building the application. You are free to add as many dependencies as you want in order to develop your application. If you choose to generate your own <code>package.json</code> file make sure you add the "postinstall", "prebuild" and "build" scripts under the "scripts" section as in the example above.</p>

            <p>Next you'll need to copy the <code>octopus.json</code> file from the <code>profile-app</code> folder to your application folder:</p>
            <psk-code>
                # go back to the web-wallet folder
                cd ../

                # copy the octopus.json file from profile app
                cp profile-app/octopus.json todo-app/
                cd todo-app
            </psk-code>

            <p>The <code>octopus.json</code> file contains actions executed by Octopus that will copy the runtime javascript bundles from PrivateSky into our new application into the <code>code</code> folder and install the <psk-link page="Cardinal/web-components-mvc">Cardinal</psk-link> framework.</p>

            <p>Next add a basic <code>index.html</code> file inside the <code>code/</code> directory:</p>
            <psk-code language="markup">
                &#x3C;!DOCTYPE html&#x3E;
                &#x3C;html lang=&#x22;en&#x22;&#x3E;

                &#x3C;head&#x3E;
                    &#x3C;meta charset=&#x22;UTF-8&#x22;&#x3E;
                    &#x3C;meta http-equiv=&#x22;x-ua-compatible&#x22; content=&#x22;IE=Edge&#x22;&#x3E;
                    &#x3C;meta name=&#x22;viewport&#x22; content=&#x22;width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0&#x22;&#x3E;
                    &#x3C;meta name=&#x22;apple-mobile-web-app-capable&#x22; content=&#x22;yes&#x22;&#x3E;

                    &#x3C;title&#x3E;To do list&#x3C;/title&#x3E;
                &#x3C;/head&#x3E;

                &#x3C;body&#x3E;
                    &#x3C;h1&#x3E;Hello World&#x3C;/h1&#x3E;
                &#x3C;/body&#x3E;

                &#x3C;/html&#x3E;
            </psk-code>

            <p>If you follow all the above instructions your <code>todo-app</code> folder should look like this:</p>
            <ul>
                <li>bin
                    <ul>
                        <li>build.js</li>
                    </ul>
                </li>
                <li>code
                    <ul>
                        <li>index.html</li>
                    </ul>
                </li>
                <li>.gitignore</li>
                <li>octopus.json</li>
                <li>package.json</li>
            </ul>
            <p>Go ahead and commit all those file in your git repository. It's time to integrate the application folder inside <code>web-wallet</code> and start adding some business logic to it:</p>
            <psk-code>
                cd todo-app
                git add --all
                git commit -am "My first commit"
            </psk-code>
        </psk-chapter>

        <psk-chapter title="Adding the SSApp in web-wallet">
            <psk-highlight type-of-highlight="issue">
                <p>Make sure the web-wallet web server is running before proceeding with the next examples.</p>
            </psk-highlight>
            <p>It is time to integrate our application inside <code>web-wallet</code> by running a few octopus commands inside the web-wallet directory:</p>
            <psk-code>
                cd web-wallet

                # This command will tell octopus to fetch the application from your git repository
                npm run add todo-app [url of your todo-app repository]

                npm run bind-app secure-channels todo-app
            </psk-code>

            <p>Some of the things the <code>bind-app</code> command does is run our <code>todo-app/bin/build.js</code> script to copy the application code into a Brick Archive and write the seed of that BAR in a file which will be used by the SSApp loader to load the application. If you browse the <code>web-wallet</code> directory you'll see that Octopus has fetched the application from git and placed inside it.<br />
            The <strong>secure-channels</strong> argument refers to the name of the software solution built with this web-wallet. You can think of <strong>secure-channels</strong> as container for SSApps.</p>

            <p>Up to this point we have completed steps 1, 2 &amp; 3 from our little gist from the beginning of the page: we have created a basic structure for our application, we added the app into web-wallet and we have binded it to the web-wallet's solution. One last step before doing the actual development work is to add a link to our application in the wallet template - if you remember the <code>web-wallet</code> comes with a wallet template which is a SSapp that displays a menu allowing you to select which application to run. We do this by editing <code>web-server/secure-channels/wallet-template/app-config.json</code> and adding an entry for our application. The <code>pages</code> section of that file should look like this:</p>
            <psk-code language="javascript">
                "pages": [
                    {
                        "name": "Home"
                    },
                    {
                        "name": "Inbox"
                    },
                    {
                        "name": "Outbox"
                    },
                    {
                        "name": "Contacts"
                    },
                    {
                        "name": "Profile"
                    },
                    {
                        "name": "To do List"
                    }
                ]
            </psk-code>

            <p>Next, go ahead and create a new html file named <code>to-do-list.html</code> inside <code>web-server/secure-channels/wallet-template/pages/</code>:</p>

            <psk-code language="markup">

                &#x3C;psk-container controller-name=&#x22;SSAppController&#x22;&#x3E;
                    &#x3C;psk-ss-app app-name=&#x22;todo-app&#x22;&#x3E;
                    &#x3C;/psk-ss-app&#x3E;
                &#x3C;/psk-container&#x3E;

            </psk-code>
            <p>The <code>psk-ss-app</code> is a Cardinal web component which handles loading and running a SSapp. The <code>to-do-list.html</code> file is actually a <code>View</code> file from the <code>wallet template</code> SSApp which will load our To do List SSapp.</p>

            <p>To verify that the application was built correctly, open the browser and load <a href="http://localhost:8080/secure-channels/loader" target="_blank">http://localhost:8080/secure-channels/loader</a>. If you have previously created a wallet using the loader make sure you clear your local storage and refresh the page. Follow the steps to create a new wallet and then open it. You should see a link to our To Do application in the left menu and when clicking it you should see the "Hello World" message.</p>
        </psk-chapter>

        <psk-chapter title="Application Development">
            <p><strong>From now on the development work will be done from within the <code>todo-app</code> folder in the <code>web-wallet</code>. The only purpose for the initial todo-app directory was to be able to install it inside web-wallet.</strong></p>
            <p>The first thing you'll need to do before adding new code to the application is to switch the SSApp loader to run in "development" mode. To do that, go into <code>web-server/secure-channels/loader</code> and create a copy of <code>loader-config.local.json-template</code> file:</p>

            <psk-code>
                cd web-server/secure-channels/loader
                cp loader-config.local.json-template loader-config.local.json
            </psk-code>

            <p>The <code>loader-config.local.json</code> is a configuration file that will allow us to override the default loader options set in <code>loader-config.js</code>. Our local configuration file will override the loader mode setting from "secure" to "development". While in development mode, the loader will skip the UI and create a new wallet if one doesn't exist, or update an existing one as the source code changes to speed up development.</p>

            <p>Next start the "watch" feature of the <code>web-wallet</code> that watches for source code changes and updates the application's BAR - remember, the SSApp, once built it is stored in a BAR in Brick Storage. In order to update the code we need to somehow update the BAR:</p>

            <psk-code>
                # inside web-wallet's directory
                npm run watch -- --app=todo-app
            </psk-code>

            <p>Clear the browse's local storage and refresh. You should see that the loader's UI isn't shown anymore and you are automatically presented with the SSApps menu. Now, everytime you change the source code of your application the wallet will be automatically rebuilt.</p>

            <p>It's time to add some functionality to our app and the first thing we need to do is update the <code>index.html</code> to include the Cardinal framework and add the <psk-link page="Cardinal/web components/app-root">psk-app-root</psk-link> component in the page's body section. Replace the inner content of the <code>body</code> tag with this one:</p>

            <psk-code language="markup">
                &#x3C;psk-app-root&#x3E;
                    &#x3C;header&#x3E;
                    &#x3C;/header&#x3E;
                    &#x3C;section&#x3E;
                        &#x3C;psk-app-router failRedirectTo=&#x22;/home&#x22;&#x3E;&#x3C;/psk-app-router&#x3E;
                    &#x3C;/section&#x3E;
                &#x3C;/psk-app-root&#x3E;

                &#x3C;script src=&#x22;/scripts/browserSupport.js&#x22;&#x3E;&#x3C;/script&#x3E;

                &#x3C;script src=&#x22;/scripts/privatesky/webshims.js&#x22;&#x3E;&#x3C;/script&#x3E;
                &#x3C;script src=&#x22;/scripts/privatesky/pskruntime.js&#x22;&#x3E;&#x3C;/script&#x3E;
                &#x3C;script src=&#x22;/scripts/privatesky/bindableModel.js&#x22;&#x3E;&#x3C;/script&#x3E;

                &#x3C;script type=&#x22;module&#x22; src=&#x22;/cardinal/cardinal.esm.js&#x22;&#x3E;&#x3C;/script&#x3E;
                &#x3C;script nomodule src=&#x22;/cardinal.js&#x22;&#x3E;&#x3C;/script&#x3E;
                &#x3C;script&#x3E;
                    globalConfig = {
                        theme: &#x27;default&#x27;
                    }
                &#x3C;/script&#x3E;
            </psk-code>

            <p>The <psk-link page="Cardinal/web components/app-router">psk-app-router</psk-link> needs some default configuration and in order to provide that we need to create the <code>app-config.json</code> in the <code>code/</code> folder of the application:</p>
            <psk-code language="javascript">
                {
                    "basePagesUrl": "/pages/",
                    "menu": {
                        "defaultMenuConfig": {
                            "icon": "fa-bars",
                            "type": "route",
                            "component": "psk-page-loader",
                            "exact": false,
                            "indexed": true,
                            "pagePrefix": "?",
                            "historyType": "query"
                        },
                        "pages": [{
                                "name": "Home",
                                "path": "/home",
                                "pageSrc": "index.html"
                            }
                        ]
                    }
                }
            </psk-code>
            <p>With this configuration we're telling the router to load the views from the <code>code/pages/</code> folder, so the next step is to add an <code>index.html</code> file in that location.</p>

            <psk-chapter title="View">
                <p>The <code>code/pages/index.html</code> view of our application will display the items in our to do list and will allow any user to add new items to that list:</p>
                <psk-code language="markup">

                    &#x3C;psk-page title=&#x22;To do list&#x22;&#x3E;
                        &#x3C;psk-container controller-name=&#x22;TodoListController&#x22;&#x3E;
                            &#x3C;!-- Render each list item from the model --&#x3E;
                            &#x3C;psk-for-each data-view-model=&#x22;items&#x22;&#x3E;
                                &#x3C;p&#x3E;&#x3C;psk-text-input value=&#x22;@item&#x22; read-only=&#x22;true&#x22;&#x3E;&#x3C;/psk-text-input&#x3E;&#x3C;/p&#x3E;
                            &#x3C;/psk-for-each&#x3E;


                            &#x3C;!-- Form controls for adding a new item --&#x3E;
                            &#x3C;p&#x3E;
                                &#x3C;psk-text-input view-model=&#x22;item&#x22;&#x3E;&#x3C;/psk-text-input&#x3E;&#x3C;br /&#x3E;
                                &#x3C;psk-button label=&#x22;Add&#x22; button-class=&#x22;btn btn-info&#x22; event-name=&#x22;list:newItem&#x22;&#x3E;&#x3C;/psk-button&#x3E;
                            &#x3C;/p&#x3E;

                            &#x3C;!-- Save button --&#x3E;
                            &#x3C;p&#x3E;&#x3C;psk-button label=&#x22;Save list&#x22; button-class=&#x22;btn btn-primary&#x22; event-name=&#x22;list:save&#x22;&#x3E;&#x3C;/psk-button&#x3E;&#x3C;/p&#x3E;
                        &#x3C;/psk-container&#x3E;
                    &#x3C;/psk-page&#x3E;

                </psk-code>
            </psk-chapter>

            <psk-chapter title="Controller">
                <p>The controller will initialize the model and handle all the events triggered by the view controls. Create the <code>code/scripts/controllers/TodoListController.js</code> file:</p>

                <psk-code language="javascript">

                    import ContainerController from "../../cardinal/controllers/base-controllers/ContainerController.js";
                    import ListModel from "./../models/ListModel.js";

                    export default class TodoListController extends ContainerController {
                        constructor(element) {
                            super(element);

                            // List model
                            this.listModel = new ListModel();

                            // Set some default values for the view model
                            this.model = this.setModel(this.listModel.toJSON());

                            // Fetch data from EDFS and populate the view model
                            this.listModel.hydrate(this.model);

                            // Add new item to the list
                            this.on('list:newItem', (e) => {
                                e.preventDefault();
                                e.stopImmediatePropagation();
                                this._addNewListItem();
                            })

                            // Save the list to EDFS
                            this.on('list:save', (e) => {
                                e.preventDefault();
                                e.stopImmediatePropagation();
                                this._saveList();
                            })
                        }

                        _addNewListItem() {
                            // Get the value from the "item" view model
                            const newItem = this.model.item.value;

                            // Appended to the "items" array
                            this.model.items.push({
                                item: newItem
                            });

                            // Clear the "item" view model
                            this.model.item.value = '';
                        }

                        _saveList() {
                            // Save data to EDFS
                            this.listModel.save(this.model)
                                .then((result) => {
                                    console.log('List was saved!')
                                })
                                .catch((err) => {
                                    console.log("An error occured");
                                    console.error(err);
                                });
                        }
                    }
                </psk-code>
            </psk-chapter>

            <psk-chapter title="Model">
                <p>The last piece of the puzzle is the model. Add the following code in <code>code/scripts/models/ListModel.js</code>. The model will fetch the data from EDFS using the <code>Download Middleware</code> of its service worker. When saving the data, the model will upload the list as a JSON file to EDFS using the <code>Upload Middleware</code> provided by the service worker.</p>

                <psk-code language="javascript">
                    export default class ListModel {

                        constructor() {
                            this.data = {
                                items: [], // holds all the items of the list
                                // view model for the "add new item" input
                                item: {
                                    name: 'item',
                                    label: 'New item'
                                }
                            };
                        }

                        /**
                        * Fetch data from EDFS and populate the view model
                        */
                        hydrate(model) {
                            // We're getting the data through the Download
                            // middleware of the Service Worker
                            return fetch('/download/data/list.json')
                                .then((response) => {
                                    if (!response.ok) {
                                        return;
                                    }

                                    return response.json().then((data) => {
                                        model.items = data.items;
                                    })
                                })
                                .catch((err) => {
                                    console.error(err);
                                })

                        }

                        /**
                        * Save the model to EDFS
                        */
                        save(data) {
                            this.data.items = data.items;

                            const listFile = new File([JSON.stringify(this.data)], 'list.json');

                            // We're using the Upload middleware of the Service Worker
                            // to upload data to EDFS.
                            const saveEndpointUrl = `/upload?path=/data&filename=${listFile.name}`;

                            return fetch(saveEndpointUrl, {
                                method: 'POST',
                                body: listFile
                            }).then((response) => {
                                return this.getJsonResponseBody(response).then((data) => {
                                    if (!response.ok || response.status != 201) {
                                        return Promise.reject("Unable to save list");
                                    }

                                    return Promise.resolve();
                                })
                            })
                        }

                        getJsonResponseBody(response) {
                            return response.json((result) => {
                                return result;
                            }).catch((err) => {
                                return Promise.resolve({});
                            })
                        };

                        /**
                        * Return a copy of the data
                        */
                        toJSON() {
                            return JSON.parse(JSON.stringify(this.data));
                        }
                    }
                </psk-code>
            </psk-chapter>
        </psk-chapter>

        <psk-chapter title="SSApp loader">
        </psk-chapter>
    </psk-chapter>
</psk-page>
